# MinIO Operations Runbook

## Purpose
Provide on-call engineers with actionable steps to operate, diagnose, and recover the MinIO content platform described in `21_content_manager/minio-content-server.md`. This runbook assumes familiarity with the MyFarsi platform, access to Vault credentials, and operator rights within the `content` namespace.

## Environment Summary
- **Clusters**: Distributed MinIO in staging (4 nodes) and production (6 nodes) running in Kubernetes.
- **Control Plane**: `minio-control` service issues upload/download sessions and publishes Kafka events.
- **Storage**: Persistent volumes on SSD/NVMe. Daily replication to secondary MinIO cluster within EU.
- **Credentials**: Root user credentials in Vault (`secret/minio/root`). Service accounts use STS tokens issued via `minio-control`.

## Regular Checks (Daily)
1. Review dashboard `Storage / MinIO` in Grafana:
   - `minio_disk_storage_bytes_free` above 20% of capacity.
   - Error rate < 1%.
   - Lifecycle job status (`minio_control_lifecycle_failures_total`).
2. Verify replication status using `mc admin replicate info`.
3. Confirm Kafka `media.asset_uploaded.v1` and `media.asset_revoked.v1` event counts in Grafana match expected upload activity.
4. Spot check signed URL issuance by querying `minio_control_requests_total` metrics.

## Weekly Tasks
- Review lifecycle cleanup logs to ensure `sandbox-*` buckets purge successfully.
- Validate object replication by running `mc mirror --watch` dry-run.
- Rotate any temporary STS credentials that exceed policy TTL.
- Check for open issues generated by drift detection jobs (GitOps vs live configuration).

## Incident Response
### High Disk Usage
1. Identify offending bucket using `mc du myfarsi-prod`.
2. Coordinate with content team to archive or delete large artifacts.
3. If immediate relief needed, expand cluster:
   - Increase StatefulSet replica count (`kubectl scale statefulset/minio ...`).
   - Run `mc admin rebalance start myfarsi-prod`.
   - Monitor progress via `mc admin rebalance status`.

### Node Failure / Pod CrashLoop
1. Check pod logs (`kubectl logs minio-<id>`).
2. Ensure Kubernetes reschedules pod; verify readiness.
3. If persistent volume issues arise, cordon node and recreate pod with new PV.
4. Confirm cluster state with `mc admin info myfarsi-prod`.

### Access Issues / Failed Uploads
1. Inspect `minio-control` logs for policy denials or Vault errors.
2. Validate Authentik headers present in requests.
3. Reissue STS credentials using `POST /v1/uploads` and verify TTL.
4. If control service unhealthy, restart Deployment and verify readiness.

### Replication Failure
1. Check `mc admin replicate status`.
2. Restart replication job (`mc admin replicate pause/resume`).
3. If target cluster unreachable, file incident and coordinate with infrastructure to restore connectivity.

### Takedown / Emergency Revocation
1. Call `POST /v1/assets/{id}/revoke` (control service endpoint).
2. Verify object moved to `archive/` prefix.
3. Confirm signed URLs invalidated by attempting access.
4. Monitor Kafka `media.asset_revoked.v1` for downstream processing.

## Backup & Restore
- Snapshots occur nightly via `mc mirror`. Snapshot bucket: `myfarsi-prod-backup`.
- To restore:
  1. Deploy replacement MinIO cluster.
  2. Apply bucket configuration (`mc ilm import`, `mc admin policy import`).
  3. Restore data (`mc mirror myfarsi-prod-backup myfarsi-prod`).
  4. Run integrity check (`mc admin heal`).
  5. Re-run control service smoke tests (upload + download).

## Credential Rotation
1. Update Vault secret versions (`vault kv put secret/minio/root ...`).
2. Refresh ExternalSecrets (`kubectl rollout restart deployment/minio-control`).
3. Validate `minio-control` can obtain new credentials (status endpoint).
4. Rotate STS key elements by redeploying services that rely on long-lived access keys.

## Verification After Changes
- Upload test file via `minio-control` API; download using signed URL.
- Confirm Kafka event emission via topic lag metrics.
- Check Grafana dashboard for anomaly-free metrics 30 minutes post-change.
- Update runbook with lessons learned if new scenarios encountered.

## Contacts & Escalation
- On-call rotation: `#oncall-media` (Slack) / PagerDuty `Media Storage`.
- Platform team: `platform-config@myfarsi.dev`.
- Security operations for takedown compliance.

## References
- `21_content_manager/minio-content-server.md`
- `20_central_bus/kafka-messaging-bus.md`
- `03_telemetry/observability-platform.md`
- Vault path documentation: `docs/security/vault-minio.md` (to be created)
